FROM node:20-alpine3.17

ARG BLOCKCHAIN_LIB_REGISTRY_READ_TOKEN=blockchain_lib_registry_read_token
ARG BLOCKCHAIN_LIB_REGISTRY_DOMAIN=blockchain_lib_registry_domain

WORKDIR /bc_coffee_lib
COPY blockchain ./blockchain
COPY src ./src

RUN npm config set @blockchain-lib:registry https://$BLOCKCHAIN_LIB_REGISTRY_DOMAIN
RUN npm config set -- "//$BLOCKCHAIN_LIB_REGISTRY_DOMAIN:_authToken" "$BLOCKCHAIN_LIB_REGISTRY_READ_TOKEN"

# install package dependencies
RUN cd /bc_coffee_lib/src && npm install

# install blockchain dependencies
RUN cd /bc_coffee_lib/blockchain && npm install --force && npm run compile

RUN cd /bc_coffee_lib/src && npm run build
